tgbot  /in-memory database

`*` are abstract variable names, or variable values, I just give the logic.
[*] is used for keyboard layouts and keyboard buttons, and set of inline buttons.
{*} is used to to determine a specific a mode or a type of view, related with conditions and/or constraint.
(*) is used for optional elements and additional instructions.
"*" bot messages sent to admin, driver and customer.

AN ORDER IS ALWAYS DISPLAYING USING ORDER TEMPLATE WITHIN TELEGRAM (front-end):
Displaying all fields, if no value set (null) just leave the field value empty. 
ğŸ†• #;
ğŸ‘¤;
ğŸ“;
ğŸ’²* BY *;
(ğŸ’°;
ğŸ’±;)
ğŸš€ ;
ğŸ“ƒ ;
(â­;)
ğŸ“…;

ORDER TEMPLATE, BACK END DEFINITIONS:
`order_status_emoji`+`order_id`=`ğŸ†•` `#`;
`customer`=`ğŸ‘¤`;
`location_link`:=`ğŸ“`;
`total_amount`(+`paid_status`)BY `payment_method`=`ğŸ’²`;
`PAID` no emoji displaying as uppercase text ;
`CASH` no emoji displaying as uppercase text;
`QR` no emoji displaying as uppercase text;
if `CASH` selected need to display extra rows:
`given_cash`=`ğŸ’°`;
`change_cash`=`ğŸ’±`;
`driver`=`ğŸš€`(replaced by `ğŸ”µ` when driver `assigned` replaced by `ğŸŸ¡` when `pickedup` reset to default `ğŸš€` when `completed`;
`items`=`ğŸ“ƒ`;
`feedback`=`â­`(emoji and value are added at the end of the flow, once set by the customer);
`date_time_stamp`=`ğŸ“…`;

ORDER TEMPLATE Type of values: 
ğŸ†• #: emoji #`order_id` (integrer, 0001 incremental by system) / nullable=false (all other fields are nullable for new orders in the admin interface);
ğŸ‘¤: `customer_name` (link to `customer_username`(telegram username));
ğŸ“: `map_link`(map url) or `location`(text);
ğŸ’²* BY *; `total_amount`(number with decimal)+`paid_status`(PAID)+BY+`payment-method`(CASH or QR);
(ğŸ’°;`given_cash`(integrer);
ğŸ’±;)`change_cash`(int)(calculated by system (`given_cash`-`total_amount`=`change_cash`));
ğŸš€ ;`driver_name`(link to `driver_username`(telegram username), if only 1 driver is connected he's automatically added;
ğŸ“ƒ ;`items`(text);
(â­;)`feedback`(1, 2, 3, 4 or 5);
`ğŸ“…``date_time_stamp`;

ORDER DETAILS Example 1: 
âš¡#0002
ğŸ‘¤kali
ğŸ“maplink
ğŸ’²23.50 PAID by QR 
ğŸŸ¡ John
ğŸ“ƒbeef burger x2
    coffee x1
    coke x2	
(this order is on the way to the customer place).
ğŸ“…

ORDER DETAILS Example 2:
ğŸ—ƒï¸ #0001
ğŸ‘¤ ilak
ğŸ“ minimart 53st
ğŸ’² 55 PAID BY CASH
ğŸ’° 100
ğŸ’± 45
ğŸš€ Jane
ğŸ“ƒ details on invoice
â­ 5
(this order has been `completed` successfully and `archived`).
ğŸ“…

ORDER DETAILS Example 3:
ğŸ†• #0003
ğŸ‘¤alik
ğŸ“maplink
ğŸ’²
ğŸš€ doe
ğŸ“ƒ
ğŸ“… 
(this is a `new_forwarded_order` in `edit_mode`).

ORDER STATUS AND ORDER STATUS EMOJIS `order_status`(back-end)=`order_status_emoji`(front-end, no label):
`order_status``order_status_emojis`(`constraint`);
new ğŸ†•(new_draft_order, new_forwarded_order, new_online_order);
assigned ğŸ›ï¸(`go_button_clicked`);
pickedupâš¡(`pickedup_button_clicked`);
arrived ğŸ(`arrived_button_clicked`);
completed âœ…(`completed_button_clicked`);
archived ğŸ—ƒï¸(`archived_button_clicked`);
cancelledâŒ(`cancel_button_clicked`);

ORDER STATUS explained
NEW ORDERS (ORDERS section)
`new_draft_order` `ğŸ†•` : A new created order created by Admin using create new draft from admin menu.
`new_forwarded_order``ğŸ†•`: A newly created order by Admin by forwarding a user message containing a map link to the bot.
`new_online_order``ğŸ†•`: A new order created online by customer using the bot.
ACTIVE ORDERS (ACTIVE section)
`assigned` `ğŸ›ï¸`: Set by Admin when clicking on [âš¡GO] button.
`pickedup` `âš¡`: Set by driver when clicking on [ğŸ›ï¸PICKUP] button.
`arrived``ğŸ`: Set by Driver or by system when clicking on [ğŸARRIVED] button, or when the driver enter in radius zone
COMPLETED ORDERS (COMPLETED section)
`completed`âœ…`: Set by driver when clicking on [âœ…COMPLETED] button.
`cancelled``âŒ`: The order has been cancelled by an admin.
`archived``ğŸ—ƒï¸`: Set by admin when clicking on [ğŸ—ƒï¸ARCHIVE] button.

ADMIN INTERFACE ADMIN MENU KEYBOARD BUTTONS (not inline)
1row: [ğŸ“¥ORDERS], [âš¡ACTIVE], [âœ…COMPLETED].
2row:[ğŸ“ŠSTATS], [âš™ï¸SETTINGS].
when opening a section orders in it are displayed as inline buttons to be clickable(openable) and showing full detail:
order as inline button [`order_status_emoji`#`order_id` for `customer_name` by `driver_name``driver_status`].

when an order is showing full details in admin interface (sent as a message from bot or displayed as a message when selected from a list in a section), EDIT MODE IS ENABLED and EDIT KEYBOARD REPLACE MENU KEYBOARD. 
[edit_keyboard] layout:
1st row: [CASH], [QR], [PAID], [ğŸ’²`total_amount`].
2nd row: [âš¡Go] (Send the order to the driver), [âŒ cancel], [â¬…ï¸ go back] (exit edit mode and showing back MENU KEYBOARD).

EDIT MODE is always set with EDIT KEYBOARD
Sending or forwarding different type of content to the bot to edit corresponding field,.
replacing existing value (except `items` new text sent (new values) are added to existing.
a map link to update `map_link`;
a telegram contact object to update `customer`;
a monetary value starting with $ to update `total_amount`;
plain text is added to `items` field.

Edited values are saved automatically:

ORDERS SECTION includes:
order with following status: `new_draft_order`, `new_forwarded_orders` and `new_online_orders`.
selecting one display it with full details in edit mode with edit keyboard.

ACTIVE SECTION includes:
order with `assigned`, `pickedup` and `arrived` status. (all order sent to a driver).
an order selected from a list in this section is showing full details ACTIVE ADMIN KEYBOARD is set.
[active_admin_keyboard] layout:
1st row: [âœï¸EDIT], [ğŸ—ºï¸driver_name], [â¬…ï¸ GO BACK].

COMPLETED SECTION include orders with status: `completed`, `canceled`, and `archived`.
[sub_menu_keyboard]:
1st row: [âœ…COMPLETED], [âŒCANCELED], [ARCHIVEDğŸ—ƒï¸].
when an order is selected from a list it displays selected order with full details and sets corresponding keyboard: 
completed order sub-section keyboard:
1st row: [â¬…ï¸PREV],[ğŸ—ƒï¸],[â¡ï¸NEXT];
canceled order sub-section keyboard:
1st row: [â¬…ï¸PREV],[âŒ](to delete definitely),[â¡ï¸NEXT];
archived order sub-section:
1st row: [â¬…ï¸PREV],[âŒ](to delete definitely from front-end only),[â¡ï¸NEXT];
[â¬…ï¸PREV] button to navigate to previous order with full details view.
[â¡ï¸NEXT] button to navigate to the next order with full details view.
all these 4 keyboard showing:
2nd row: [â†©ï¸GO BACK].
 
ADMIN SETTINGS MENU
[QR Codes: [â• NEW QR] to add new, then showing existing using {list_view}, when opening existing from the list, attach inline buttons: [âœï¸EDIT],[ğŸ”´DISABLE] 
(if set to enabled, if not [ğŸŸ¢ACTIVATE] to enable, only 1 qr enabled at a time, enabling a qr disable any previous enabled).
[Drivers]: [â• DRIVER] to add new (display a predefined message in Khmer language to register with a bot link that run  /register command), driver registering this way no need approval, he can use [ğŸŸ¢ CONNECT] button directly.
Showing existing using {list_view}, when opening existing from the list (`driver_status`+`driver_name`+`total_stars`) when opening showing as a contact card (telegram function).
attach inline buttons: if driver is blocked showing a warning: "âš ï¸ Driver is blocked  Unblock?" inline button attached to the text [OK], [â¬…ï¸].
[RESTAURANT MENUS]: [Food menu en], [Food menu ru], [Drink menu en], [Drink menu ru] (select menu to edit, sending media using telegram function, media should be sent grouped as a single message, new set of media will replace existing one).
[Advanced] 
[Admins]: [â• ADD NEW] to add a new admin (generating a temporary link to forward, on click user is added as admin) then showing existing using {list_view}, when opening existing from the list, attach inline buttons: [â›” BLOCK],[ğŸŸ¢UNBLOCK],[âŒDELETE];
[No label mode] {emoji_mode}: switch to use emoji only (displaying buttons without labels, admin interface only, except settings menu), if `emoji_mode_enabled` show `label_mode` instead to restore normal mode.
[Data]; [AUTO], in-memory databases are saved automatically daily at 00:00 (this option has been created for future use, in case of slow performances or bug, implementation will be improved),

SETTINGS FLOWS:
QR CODE FLOW:
([â• NEW QR] flow:
Take, send or forward a picture:
Select devise: [USD],[KHR];
Select bank:
[ACLEDA];
[ABA];
[BAKONG];
[HUYONE];
[KHOR](common protocol);
[OTHER];
Saved! This is the first QR registered, it has been activated!)

DRIVER STATS:
[ğŸ“ŠSTATS] to display order summaries, opening using {card_view};
`ğŸŸ¢``connected_time`;
`â°``waiting_time`;
`âš¡``driving_time`.;
`âœ…``order_completed`;
`â­`` total_stars`;
`ğŸ“…``date_time_stamp`;
Set [summary_keyboard]:[]
1st row: [â¬…ï¸PREV], [â¡ï¸NEXT];
2nd row: [â†©ï¸BACK TO MENU];

SESSIONS AND DATA RETENTION
admin is always connected and available (24/7), [reset shift] button from the settings, archives all completed orders.

NOTIFICATION SYSTEM MESSAGES (TOASTS):  
Bot handles sending different types of messages, direct in a chat, pop up from chat, notification messages (can be silent) and toast notifications.
All driver actions (keyboard buttons) are notified to admin using toasts, (`driver_name` just picked up `customer_name` order. `driver_name` is sharing location with `customer_name`. `driver_name` noticed `customer_name` about `delay_value` delay. `driver_name` is arrived at `customer_name` place. `driver_name` has completed `customer_name` order. `customer_name` gave `feedback_note` to `driver_name`.  
By default, all action executed by admin and drivers from their interface return a short toast message confirmation (without values) : "Order sent", "Connected", "Reply sent", "Message sent", "Sharing live location started", etc...

IN-MEMORY DATA STORES:
The following arrays and maps will serve as in-memory databases:
`orders: Order[]`;
`drivers: Driver[]`;
`customers: Customer[]`;
`sessions: Session[]`;
`qrCodes: QRCode[]`;

TRANSLATION:
/kh to use khmer translation for driver interface (translations are hard coded).
/en to set driver interface language in english.

LIST OF AVAILABLE COMMANDS:
/cancel command allows a driver to force cancelling the active order.
/settings

SPECIFIC CASES:
/help command opens a chat session from customer interface directly with admin using bot to send and forward messages:
"Direct chat session with admin started",
"Ask your question to connect the chat"[END SESSION], 
notify admin "Attention required from `customer_name`)",
"Direct chat session with `customer_name` initialized..."[END SESSION],
"`customer_name` say: `customer_request`".

CUSTOMER FLOW (/start):
/start command-> set items with bot -> set location with bot -> admin request payment method -> pay online with bot -> admin send order to driver -> driver pick up order (customer session with driver remains open till completing the process) -> driver sets arrived -> customer receive goods and give cash to driver to complete the payment process-> driver sets completed -> customer feedback -> admin archive order to save customer data.

CUSTOMER ONLINE ORDERING FLOW `new_online_order` using chat with bot:
/start command from bot, first time connection, first time ordering:
when chatting with bot [BUTTON] are inline buttons (cust1:omer flow uses only inline buttons attached to the bot message, not keyboards layout are defined for customer)
"Please choose your language:" [flag English], [flag Russian].
"Messages sent to the bot will be forwarded to admin, you can ask for /help or any special request anytime".
"Welcome `customer_name`, please share your location" [ğŸ—ºï¸SHARE LOCATION].
"Noted, thank you, now text me the items you would like to order" [`food_menu`], [`drink_menu`]Â (hidden if not set from admin interface), [ğŸ“¤SEND ORDER].
"Excellent choice! Your order has been sent to admin, you will receive a confirmation in a minute.".
"Order approved! TotalğŸ’²`total_amount` Please select a payment method:" [CASH], [QR].
if [QR] selected bot sends `enabled_qr_picture` with message: "Total: `total_amount` , Scan to proceed with the payment, once the payment sent, press done button"[â˜‘ï¸DONE];
"Thank you for your payment! have a good day and see you next time in the metaverse!".
if [CASH] selected: "What cash devise  will you use?"[USD],[KHR], "Select predefined `selected_devise` amount note or send custom amount using"if [USD]: [$10], [$20], [$50], [$100], if [KHR]: [50k], [80k], [100k], [150k];
"Thank you, your driver has been notified and will care about your change, you will be notified when your order will be on the way."
if `change_cash`<2 [Change is less than 2$ TIP (`change_cash`) to support your driver].
->DRIVER FLOW.

DRIVER FLOW (MESSAGES SENT TO CUSTOMER)
`pickedup_message`: 1st message: 
"Your order `order_id` has been picked up, Your driver is on the way and should be at destination within 20 minutes" (wait 5 secondes and send 2nd message):
"If your driver is late, you use can use â”button to ping the driver, he will send you ETA" [â”ETA] inline button
`arrived_message`: 
"Hi, here's `driver_name`, I'm just arrived at your place, please come to get your meal" [OK] inline button sends message to the driver: "`customer_name` is coming" .
`completed_message`:
 "Thank you for ordering with us dear `customer\_name`! ğŸ¤—" wait 5 seconds send `feedback_message`: ''Please rate your delivery experience â­, send any text to the bot as a feedback" [1],[2],[3],[4],[5].
[1]-[5] buttons: bot reply to the customer:
"Thank you, CVIK2 team wish you a good day, or a good night, we wish you both! ğŸ˜" .
bot sends `feedback_text` as a message to admin: "Some important words from `customer_name`".
bot sends `feedback_note`â­ as a message to driver: "`customer_name`" gave you `feedback_note`â­ (if `4â­` or `5â­` add "Really good job ğŸ’ª")" and,
â­ field and `feedback_note``feedback_text` values are added to the order and,
wait 5 minutes before closing customer session, bot sends silent message to customer: "Session terminated, thank you for you personal data, reselling them is profitable and generate good side incomes, unfortunately it doesn't but we keep them to make your next order even faster! *messages sent to the bot are fowarded to admin".

[â”ETA] button: it sends a message to the driver: "Customer is waiting for a while and want to know about ETA".
[2mn],[5mn],[+10mn],[ğŸ—ºï¸location] inline buttons.
[delay_keyboard] buttons (predefined buttons to notice politely a delay to a customer):
[2mn] button: "Hi, here's ``driver_name`, I am really close, just a couple of minutes ğŸ™";
[5mn] button: "Hi, here's ``driver_name`, traffic is dense, I am not far. Give me 5 minutes ğŸ™";
[+10mn] button: "Hi, here's ``driver_name`, I am sorry we are busier than usual. I am on the way and doing my best to deliver your meal in about 10 minutes. Thank you for your patience";
Driver press [ğŸ—ºï¸location] button, it sends drivers live location to customer (validity 30mn, ends when [âœ…COMPLETED] is pressed). 

ADMIN ONLINE ORDER FLOW:
`new_online_order` -> edit mode (edit any value) -> admin sets `total_amount` -> triggers bot flow `order_approved` (bot ask the customer about the payment) CUSTOMER FLOW -> DRIVER FLOW.
`new_draft_order` (forward a draft to customer, triggers `online_order_flow` if user didn't initialize a chat with bot it will return an error "Unknown customer, need to send bot link to customer using manager account" (displaying a message with bot link that runs /start command) ) and `new_forwarded_order`
Admin edit fields -> prompt customer for items items clicks `Go` -> order sent to driver and to the customer  -> `order_status` set as `assigned` -> `driver_status` set as `ready` -> driver clicks pickup -> `order_status` set to `pickedup` -> `arrived` (Driver or admin clicks `Arrived`) -> `completed` (Driver or admin clicks `Completed`) -> `Archived` admin set as.

ORDER SENT TO DRIVER {card_view} (driver interface does not include edit mode):
admin pressed [âš¡GO] button, with driver assigned `driver_status``ready ğŸ”µ`:
{card_view} `driver_active_order` 
[ready_keyboard]: [ğŸ›ï¸ PICKUP],[ğŸ›£ï¸ROUTE]
[ğŸ›ï¸ PICKUP] button clicked send `pickedup_message` to customer and replace [pickup_keyboard] with [active_driver_keyboard](1row): [ğŸarrived], [ğŸ—ºï¸location], [â°delay].
[ğŸ›£ï¸Route] button when clicked display a map preview with details:
ğŸ›µ `total_distance` Km;
ğŸ“ `distance_to_destination`;
ğŸ• ETA `eta_timer` minutes;
ğŸ Time at destination `eta_time`;

[ğŸARRIVED] button clicked send `arrived_message` to the customer and replace [active_driver_keyboard] with [arrived_keyboard](1row,1 button) :[âœ…COMPLETED].
[ğŸARRIVED] is triggered automatically when `driver_is_near``map_link_location``radius_50` (radius <50 meters), button still showing if `driver_is_near` failed to run.

[ğŸ—ºï¸location] button clicked sends live location to customer Â (validity 30mn, ends when [âœ…COMPLETED] is pressed).
[â°delay] button clicked shows [delay_keyboard]:[2mn],[5mn],[+10mn],[â¬…ï¸go back].
[âœ…COMPLETED] button triggers a message to the customer `completed_message`, set `order_status` -> `completed``âœ…` -> `driver_status``ğŸŸ¢``online`.

DRIVER FLOW (/register or /connect or /login):
/register command -> admin approval -> `offline ğŸ”´ ` -> driver press [ğŸŸ¢CONNECT] button to change his status to `online ğŸŸ¢` -> Driver receive order from admin `driver_status` set as `ready ğŸ”µ` -> driver press [ğŸ›ï¸PICKUP] button, `driver_status` `busy ğŸŸ¡`  -> driver press [âœ… COMPLETED] `driver_status` `online ğŸŸ¢` -> driver press [ğŸ”´DISCONNECT] `driver_status` `offline ğŸ”´`.

ADMIN FLOW DRIVER REGISTRATION AND CONNECTION:
/register command to register as a new driver, send message to admin: "NEW DRIVER `name` wants to join the team " showing contact/profile card, [YESSS] and [NO WAY] inline buttons are attached.
[YESS] button reply "Registration approved! Welcome in the CVIK2 team `driver\_name`!
connect to start receiving order" [CONNECT] inline button, [driver_connect_keyboard](1 row, 1 button): [ğŸŸ¢CONNECT].
[NO WAY] button, reply "Ok if you work for free".
[ğŸŸ¢CONNECT] button clicked, driver is connected and can be assigned to orders, showing [driver_keyboard]: 1st row: [âš¡ACTIVE], [âœ… COMPLETED], [ğŸ—ºï¸ LOCATION](to send live location to admin);
2nd row: [ğŸ”§SETTINGS], [â­•LOGOUT].
/connect and /login commands to appear online for registered drivers.
/disconnect and logout commands to appear offline, (if sent and driver still have active orders, pops up "âš ï¸ Please, complete all your assigned tasks in order to logout", after 3 attempts driver is blocked `driver_status``blocked``âš ï¸`, account need to be unfrozen by admin), on logout bot sends shift summary (`shift_summary` are saved and accessible from admin interface, driver details):
using {card_view};
`ğŸŸ¢``connected_time`;
`â°``waiting_time`;
`âš¡``driving_time`.;
`âœ…``order_completed`;
`â­`` total_stars`;
`ğŸ“…``date_time_stamp`;

DRIVER SETTINGS:
[KH],[EN]. (change driver interface language) (all elements are translated except orders details).
[AUTO],[ğŸ›£ï¸Route], [ğŸ—ºï¸location], [â°delay].
can set for each:
[ALWAYS SEND], [SEND WHEN REQUESTED], [ATTACH TO PING](prompt to allow).

DRIVER STATUS:
`ğŸŸ¢` `online`: The driver is available to accept new orders. (also set when clicking on completed).
`ğŸ”´` `offline`: The driver is not available.
`ğŸŸ¡` `busy`: The driver has picked up an order, driving.
`ğŸ”µ` `assigned`: The driver has received an order but has not yet pick it up,
`âš ï¸` `blocked`: blocked by admin, connection refused.


